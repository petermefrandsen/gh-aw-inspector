---
name: Run Tests

on: # yamllint disable-line rule:truthy
  pull_request:
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - '.vscode-test.mjs'
      - 'Makefile'
      - '.github/workflows/tests.yml'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - '.vscode-test.mjs'
      - 'Makefile'
      - '.github/workflows/tests.yml'
  workflow_dispatch:

permissions: {}

jobs:
  unit-tests:
    name: UT
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      COVERAGE_LIMIT: 70
    steps:
      - name: Checkout The Source Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: |
          set -o pipefail
          xvfb-run -a make test-unit COVERAGE=true 2>&1 | tee coverage-output.txt

      - name: Coverage Report
        if: github.event_name == 'pull_request' && always()
        uses: aGallea/tests-coverage-report@09569ca76e7040ffc16bac6a9a869fb154bf554b # v1.3.11
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          title: GH AW Inspector â€“ Coverage Report
          lcov-path: ./coverage/lcov.info
          min-coverage-percentage: ${{ env.COVERAGE_LIMIT }}
          fail-under-coverage-percentage: 'false'
          show-junit: 'false'

      - name: Extract coverage percentage
        id: coverage-report
        run: |
          COVERAGE=$(grep "^Lines" coverage-output.txt \
            | grep -oP '[0-9]+\.[0-9]+' \
            | head -1 \
            | awk '{printf "%.0f", $1}')
          echo "coverage=$COVERAGE" >> "$GITHUB_OUTPUT"

      - name: Create the Badge
        if: github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483 # v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: gh-aw-inspector-coverage.json
          label: Coverage
          message: ${{ steps.coverage-report.outputs.coverage }}%
          valColorRange: ${{ steps.coverage-report.outputs.coverage }}
          maxColorRange: 90
          minColorRange: ${{ env.COVERAGE_LIMIT }}

      - name: Fail if coverage too low
        if: ${{ fromJSON(steps.coverage-report.outputs.coverage) < fromJSON(env.COVERAGE_LIMIT) }}
        run: |
          echo "Coverage ${{ steps.coverage-report.outputs.coverage }}% is below the minimum of ${{ env.COVERAGE_LIMIT }}%!"
          exit 1
